!function(e,t){"function"==typeof define&&define.amd?define(t):"undefined"!=typeof exports?module.exports=t():e.atmosphere=t()}(this,function(){"use strict";var e,t="2.2.13-javascript",n={},o=!1,r=[],a=[],i=0,s=Object.prototype.hasOwnProperty;return n={onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(e){var t,o;return e.onMessage=function(e){o.onmessage({data:e.responseBody})},e.onMessagePublished=function(e){o.onmessage({data:e.responseBody})},e.onOpen=function(e){o.onopen(e)},o={close:function(){t.close()},send:function(e){t.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},t=new n.subscribe(e),o},AtmosphereRequest:function(e){function r(){we=!0,Re=!1,Te=0,me=null,he=null,be=null,ve=null}function s(){p(),r()}function c(e){return"debug"==e?"debug"===pe.logLevel:"info"==e?"info"===pe.logLevel||"debug"===pe.logLevel:"warn"==e?"warn"===pe.logLevel||"info"===pe.logLevel||"debug"===pe.logLevel:"error"==e?"error"===pe.logLevel||"warn"===pe.logLevel||"info"===pe.logLevel||"debug"===pe.logLevel:!1}function l(e){c("debug")&&n.util.debug(new Date+" Atmosphere: "+e)}function u(e,t){return""===ge.partialMessage&&"streaming"===t.transport&&e.responseText.length>t.maxStreamingLength?!0:!1}function d(){if(pe.enableProtocol&&!pe.firstMessage){var e="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+pe.uuid;n.util.each(pe.headers,function(t,o){var r=n.util.isFunction(o)?o.call(this,pe,pe,ge):o;null!=r&&(e+="&"+encodeURIComponent(t)+"="+encodeURIComponent(r))});var t=pe.url.replace(/([?&])_=[^&]*/,e);t+=t===pe.url?(/\?/.test(pe.url)?"&":"?")+e:"";var o={connected:!1},r=new n.AtmosphereRequest(o);r.connectTimeout=pe.connectTimeout,r.attachHeadersAsQueryString=!1,r.dropHeaders=!0,r.url=t,r.contentType="text/plain",r.transport="polling",r.method="GET",r.data="",r.heartbeat=null,pe.enableXDR&&(r.enableXDR=pe.enableXDR),r.async=pe.closeAsync,$("",r)}}function f(){l("Closing (AtmosphereRequest._close() called)"),Re=!0,pe.reconnectId&&(clearTimeout(pe.reconnectId),delete pe.reconnectId),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer),pe.reconnect=!1,ge.request=pe,ge.state="unsubscribe",ge.responseBody="",ge.status=408,ge.partialMessage="",le(),d(),p()}function p(){ge.partialMessage="",pe.id&&clearTimeout(pe.id),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer),pe.reconnectId&&(clearTimeout(pe.reconnectId),delete pe.reconnectId),null!=ve&&(ve.close(),ve=null),null!=ye&&(ye.abort(),ye=null),null!=be&&(be.abort(),be=null),null!=me&&(me.canSendMessage&&(l("invoking .close() on WebSocket object"),me.close()),me=null),null!=he&&(he.close(),he=null),g()}function g(){null!=ue&&(clearInterval(de),document.cookie=fe+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",ue.signal("close",{reason:"",heir:Re?(ue.get("children")||[])[0]:Ae}),ue.close()),null!=xe&&xe.close()}function m(e){s(),pe=n.util.extend(pe,e),pe.mrequest=pe.reconnect,pe.reconnect||(pe.reconnect=!0)}function h(){return null!=pe.webSocketImpl||window.WebSocket||window.MozWebSocket}function b(){var e=n.util.getAbsoluteURL(pe.url.toLowerCase()),t=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(e),o=!(!t||t[1]==window.location.protocol&&t[2]==window.location.hostname&&(t[3]||("http:"===t[1]?80:443))==(window.location.port||("http:"===window.location.protocol?80:443)));return window.EventSource&&(!o||!n.util.browser.safari||n.util.browser.vmajor>=7)}function v(){if(pe.shared){if(xe=y(pe),null!=xe&&(c("debug")&&n.util.debug("Storage service available. All communication will be local"),xe.open(pe)))return;c("debug")&&n.util.debug("No Storage service available."),xe=null}pe.firstMessage=0==i?!0:!1,pe.isOpen=!1,pe.ctime=n.util.now(),0===pe.uuid&&(pe.uuid=i),ge.closedByClientTimeout=!1,"websocket"!==pe.transport&&"sse"!==pe.transport?D(pe):"websocket"===pe.transport?h()?A(!1):U("Websocket is not supported, using request.fallbackTransport ("+pe.fallbackTransport+")"):"sse"===pe.transport&&(b()?x(!1):U("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+pe.fallbackTransport+")"))}function y(e){function t(e,t){var n,o=e.length;for(n=0;o>n;n++)e[n]===t&&e.splice(n,1);return o!==e.length}function o(t){var o=n.util.parseJSON(t),r=o.data;if("c"===o.target)switch(o.type){case"open":T("opening","local",pe);break;case"close":s||(s=!0,"aborted"===r.reason?f():r.heir===Ae?v():setTimeout(function(){v()},100));break;case"message":re(r,"messageReceived",200,e.transport);break;case"localMessage":oe(r)}}function r(){var e=new RegExp("(?:^|; )("+encodeURIComponent(c)+")=([^;]*)").exec(document.cookie);return e?n.util.parseJSON(decodeURIComponent(e[2])):void 0}var a,i,s,c="atmosphere-"+e.url,l={storage:function(){function r(e){e.key===c&&e.newValue&&o(e.newValue)}if(n.util.storage){var a=window.localStorage,i=function(e){return n.util.parseJSON(a.getItem(c+"-"+e))},s=function(e,t){a.setItem(c+"-"+e,n.util.stringifyJSON(t))};return{init:function(){return s("children",i("children").concat([Ae])),n.util.on(window,"storage",r),i("opened")},signal:function(e,t){a.setItem(c,n.util.stringifyJSON({target:"p",type:e,data:t}))},close:function(){var o=i("children");n.util.off(window,"storage",r),o&&t(o,e.id)&&s("children",o)}}}},windowref:function(){var e=window.open("",c.replace(/\W/g,""));if(e&&!e.closed&&e.callbacks)return{init:function(){return e.callbacks.push(o),e.children.push(Ae),e.opened},signal:function(t,o){!e.closed&&e.fire&&e.fire(n.util.stringifyJSON({target:"p",type:t,data:o}))},close:function(){s||(t(e.callbacks,o),t(e.children,Ae))}}}};return a=r(),!a||n.util.now()-a.ts>1e3||!(i=l.storage()||l.windowref())?void 0:{open:function(){var t;return de=setInterval(function(){var e=a;a=r(),a&&e.ts!==a.ts||o(n.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),t=i.init(),t&&setTimeout(function(){T("opening","local",e)},50),t},send:function(e){i.signal("send",e)},localSend:function(e){i.signal("localSend",n.util.stringifyJSON({id:Ae,event:e}))},close:function(){Re||(clearInterval(de),i.signal("close"),i.close())}}}function w(){function e(e){var t=n.util.parseJSON(e),o=t.data;if("p"===t.target)switch(t.type){case"send":_(o);break;case"localSend":oe(o);break;case"close":f()}}function t(){document.cookie=fe+"="+encodeURIComponent(n.util.stringifyJSON({ts:n.util.now()+1,heir:(o.get("children")||[])[0]}))+"; path=/"}var o,r="atmosphere-"+pe.url,a={storage:function(){function t(t){t.key===r&&t.newValue&&e(t.newValue)}if(n.util.storage){var o=window.localStorage;return{init:function(){n.util.on(window,"storage",t)},signal:function(e,t){o.setItem(r,n.util.stringifyJSON({target:"c",type:e,data:t}))},get:function(e){return n.util.parseJSON(o.getItem(r+"-"+e))},set:function(e,t){o.setItem(r+"-"+e,n.util.stringifyJSON(t))},close:function(){n.util.off(window,"storage",t),o.removeItem(r),o.removeItem(r+"-opened"),o.removeItem(r+"-children")}}}},windowref:function(){var t,o=r.replace(/\W/g,""),a=document.getElementById(o);return a||(a=document.createElement("div"),a.id=o,a.style.display="none",a.innerHTML='<iframe name="'+o+'" />',document.body.appendChild(a)),t=a.firstChild.contentWindow,{init:function(){t.callbacks=[e],t.fire=function(e){var n;for(n=0;n<t.callbacks.length;n++)t.callbacks[n](e)}},signal:function(e,o){!t.closed&&t.fire&&t.fire(n.util.stringifyJSON({target:"c",type:e,data:o}))},get:function(e){return t.closed?null:t[e]},set:function(e,n){t.closed||(t[e]=n)},close:function(){}}}};Ce=function(e){o.signal("message",e)},o=a.storage()||a.windowref(),o.init(),c("debug")&&n.util.debug("Installed StorageService "+o),o.set("children",[]),null==o.get("opened")||o.get("opened")||o.set("opened",!1),fe=encodeURIComponent(r),t(),de=setInterval(t,1e3),ue=o}function T(e,t,n){if(pe.shared&&"local"!==t&&w(),null!=ue&&ue.set("opened",!0),n.close=function(){f()},Te>0&&"re-connecting"===e)n.isReopen=!0,j(ge);else if(null==ge.error){ge.request=n;var o=ge.state;ge.state=e;var r=ge.transport;ge.transport=t;var a=ge.responseBody;le(),ge.responseBody=a,ge.state=o,ge.transport=r}}function S(e){e.transport="jsonp";var t,o=pe;null!=e&&"undefined"!=typeof e&&(o=e),ye={open:function(){function r(){o.lastIndex=0,o.openId&&clearTimeout(o.openId),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),o.reconnect&&Te++<o.maxReconnectOnClose?(T("re-connecting",o.transport,o),N(ye,o,e.reconnectInterval),o.openId=setTimeout(function(){X(o)},o.reconnectInterval+1e3)):M(0,"maxReconnectOnClose reached")}function a(){var n=o.url;null!=o.dispatchUrl&&(n+=o.dispatchUrl);var a=o.data;o.attachHeadersAsQueryString&&(n=B(o),""!==a&&(n+="&X-Atmosphere-Post-Body="+encodeURIComponent(a)),a="");var s=document.head||document.getElementsByTagName("head")[0]||document.documentElement;t=document.createElement("script"),t.src=n+"&jsonpTransport="+i,t.clean=function(){t.clean=t.onerror=t.onload=t.onreadystatechange=null,t.parentNode&&t.parentNode.removeChild(t),2===++e.scriptCount&&(e.scriptCount=1,r())},t.onload=t.onreadystatechange=function(){l("jsonp.onload"),(!t.readyState||/loaded|complete/.test(t.readyState))&&t.clean()},t.onerror=function(){l("jsonp.onerror"),e.scriptCount=1,t.clean()},s.insertBefore(t,s.firstChild)}var i="atmosphere"+ ++Ae;window[i]=function(t){if(l("jsonp.window"),e.scriptCount=0,o.reconnect&&-1===o.maxRequest||o.requestCount++<o.maxRequest){if(o.executeCallbackBeforeReconnect||N(ye,o,o.pollingInterval),null!=t&&"string"!=typeof t)try{t=t.message}catch(r){}var a=H(t,o,ge);a||re(ge.responseBody,"messageReceived",200,o.transport),o.executeCallbackBeforeReconnect&&N(ye,o,o.pollingInterval),O(o)}else n.util.log(pe.logLevel,["JSONP reconnect maximum try reached "+pe.requestCount]),M(0,"maxRequest reached")},setTimeout(function(){a()},50)},abort:function(){t&&t.clean&&t.clean()}},ye.open()}function k(e){return null!=pe.webSocketImpl?pe.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function R(){return B(pe,n.util.getAbsoluteURL(pe.webSocketUrl||pe.url)).replace(/^http/,"ws")}function C(){var e=B(pe);return e}function x(e){ge.transport="sse";var t=C();if(c("debug")&&(n.util.debug("Invoking executeSSE"),n.util.debug("Using URL: "+t)),e&&!pe.reconnect)return void(null!=he&&p());try{he=new EventSource(t,{withCredentials:pe.withCredentials})}catch(o){return M(0,o),void U("SSE failed. Downgrading to fallback transport and resending")}pe.connectTimeout>0&&(pe.id=setTimeout(function(){e||p()},pe.connectTimeout)),he.onopen=function(t){l("sse.onopen"),O(pe),c("debug")&&n.util.debug("SSE successfully opened"),pe.enableProtocol?pe.isReopen&&(pe.isReopen=!1,T("re-opening",pe.transport,pe)):e?T("re-opening","sse",pe):T("opening","sse",pe),e=!0,"POST"===pe.method&&(ge.state="messageReceived",he.send(pe.data))},he.onmessage=function(e){if(l("sse.onmessage"),O(pe),!pe.enableXDR&&e.origin&&e.origin!==window.location.protocol+"//"+window.location.host)return void n.util.log(pe.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);ge.state="messageReceived",ge.status=200,e=e.data;var t=H(e,pe,ge);t||(le(),ge.responseBody="",ge.messages=[])},he.onerror=function(t){l("sse.onerror"),clearTimeout(pe.id),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer),ge.closedByClientTimeout||(ce(e),p(),Re?n.util.log(pe.logLevel,["SSE closed normally"]):e?pe.reconnect&&"sse"===ge.transport&&(Te++<pe.maxReconnectOnClose?(T("re-connecting",pe.transport,pe),pe.reconnectInterval>0?pe.reconnectId=setTimeout(function(){x(!0)},pe.reconnectInterval):x(!0),ge.responseBody="",ge.messages=[]):(n.util.log(pe.logLevel,["SSE reconnect maximum try reached "+Te]),M(0,"maxReconnectOnClose reached"))):U("SSE failed. Downgrading to fallback transport and resending"))}}function A(e){ge.transport="websocket";var t=R(pe.url);if(c("debug")&&n.util.debug("Invoking executeWebSocket, using URL: "+t),e&&!pe.reconnect)return void(null!=me&&p());me=k(t),null!=pe.webSocketBinaryType&&(me.binaryType=pe.webSocketBinaryType),pe.connectTimeout>0&&(pe.id=setTimeout(function(){if(e);else{var t={code:1002,reason:"",wasClean:!1};me.onclose(t);try{p()}catch(n){}}},pe.connectTimeout)),me.onopen=function(t){l("websocket.onopen"),O(pe),o=!1,c("debug")&&n.util.debug("Websocket successfully opened");var r=e;null!=me&&(me.canSendMessage=!0),pe.enableProtocol||(e=!0,r?T("re-opening","websocket",pe):T("opening","websocket",pe)),null!=me&&"POST"===pe.method&&(ge.state="messageReceived",me.send(pe.data))},me.onmessage=function(t){l("websocket.onmessage"),O(pe),pe.enableProtocol&&(e=!0),ge.state="messageReceived",ge.status=200,t=t.data;var n="string"==typeof t;if(n){var o=H(t,pe,ge);o||(le(),ge.responseBody="",ge.messages=[])}else{if(t=I(pe,t),""===t)return;ge.responseBody=t,le(),ge.responseBody=null}},me.onerror=function(e){l("websocket.onerror"),clearTimeout(pe.id),pe.heartbeatTimer&&clearTimeout(pe.heartbeatTimer)},me.onclose=function(t){if(l("websocket.onclose"),clearTimeout(pe.id),"closed"!==ge.state){var r=t.reason;if(""===r)switch(t.code){case 1e3:r="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:r="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:r="The endpoint is terminating the connection due to a protocol error.";break;case 1003:r="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:r="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:r="Unknown: no status code was provided even though one was expected.";break;case 1006:r="Connection was closed abnormally (that is, with no close frame being sent)."}if(c("warn")&&n.util.warn("Websocket closed, reason: "+r+" - wasClean: "+t.wasClean),ge.closedByClientTimeout||o)return void(pe.reconnectId&&(clearTimeout(pe.reconnectId),delete pe.reconnectId));ce(e),ge.state="closed",Re?n.util.log(pe.logLevel,["Websocket closed normally"]):e?pe.reconnect&&"websocket"===ge.transport&&(p(),Te++<pe.maxReconnectOnClose?(T("re-connecting",pe.transport,pe),pe.reconnectInterval>0?pe.reconnectId=setTimeout(function(){ge.responseBody="",ge.messages=[],A(!0)},pe.reconnectInterval):(ge.responseBody="",ge.messages=[],A(!0))):(n.util.log(pe.logLevel,["Websocket reconnect maximum try reached "+pe.requestCount]),c("warn")&&n.util.warn("Websocket error, reason: "+t.reason),M(0,"maxReconnectOnClose reached"))):U("Websocket failed on first connection attempt. Downgrading to "+pe.fallbackTransport+" and resending")}};var r=navigator.userAgent.toLowerCase(),a=r.indexOf("android")>-1;a&&void 0===me.url&&me.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function I(e,t){var o=t;if("polling"===e.transport)return o;if(e.enableProtocol&&e.firstMessage&&0!==n.util.trim(t).length){var r=e.trackMessageLength?1:0,a=t.split(e.messageDelimiter);if(a.length<=r+1)return o;if(e.firstMessage=!1,e.uuid=n.util.trim(a[r]),a.length<=r+2&&n.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),Se=parseInt(n.util.trim(a[r+1]),10),ke=a[r+2],"long-polling"!==e.transport&&X(e),i=e.uuid,o="",r=e.trackMessageLength?4:3,a.length>r+1)for(var s=r;s<a.length;s++)o+=a[s],s+1!==a.length&&(o+=e.messageDelimiter);0!==e.ackInterval&&setTimeout(function(){_("...ACK...")},e.ackInterval)}else e.enableProtocol&&e.firstMessage&&n.util.browser.msie&&+n.util.browser.version.split(".")[0]<10?n.util.log(pe.logLevel,["Receiving unexpected data from IE"]):X(e);return o}function O(e){clearTimeout(e.id),e.timeout>0&&"polling"!==e.transport&&(e.id=setTimeout(function(){L(e),d(),p()},e.timeout))}function L(e){ge.closedByClientTimeout=!0,ge.state="closedByClient",ge.responseBody="",ge.status=408,ge.messages=[],le()}function M(e,t){p(),clearTimeout(pe.id),ge.state="error",ge.reasonPhrase=t,ge.responseBody="",ge.status=e,ge.messages=[],le()}function H(e,t,n){if(e=I(t,e),0===e.length)return!0;if(n.responseBody=e,t.trackMessageLength){e=n.partialMessage+e;var o=[],r=e.indexOf(t.messageDelimiter);if(-1!=r){for(;-1!==r;){var a=e.substring(0,r),i=+a;if(isNaN(i))throw new Error('message length "'+a+'" is not a number');r+=t.messageDelimiter.length,r+i>e.length?r=-1:(o.push(e.substring(r,r+i)),e=e.substring(r+i,e.length),r=e.indexOf(t.messageDelimiter))}return n.partialMessage=e,0!==o.length?(n.responseBody=o.join(t.messageDelimiter),n.messages=o,!1):(n.responseBody="",n.messages=[],!0)}}return n.responseBody=e,n.messages=[e],!1}function U(e){n.util.log(pe.logLevel,[e]),"undefined"!=typeof pe.onTransportFailure?pe.onTransportFailure(e,pe):"undefined"!=typeof n.util.onTransportFailure&&n.util.onTransportFailure(e,pe),pe.transport=pe.fallbackTransport;var t=-1===pe.connectTimeout?0:pe.connectTimeout;pe.reconnect&&"none"!==pe.transport||null==pe.transport?(pe.method=pe.fallbackMethod,ge.transport=pe.fallbackTransport,pe.fallbackTransport="none",t>0?pe.reconnectId=setTimeout(function(){v()},t):v()):M(500,"Unable to reconnect with fallback transport")}function B(e,o){var r=pe;return null!=e&&"undefined"!=typeof e&&(r=e),null==o&&(o=r.url),r.attachHeadersAsQueryString?-1!==o.indexOf("X-Atmosphere-Framework")?o:(o+=-1!==o.indexOf("?")?"&":"?",n.util.isArray(r.attachHeadersAsQueryString)?(-1!==n.util.inArray("X-Atmosphere-tracking-id",r.attachHeadersAsQueryString)&&(o+="X-Atmosphere-tracking-id="+r.uuid),-1!==n.util.inArray("X-Atmosphere-Framework",r.attachHeadersAsQueryString)&&(o+="&X-Atmosphere-Framework="+t),-1!==n.util.inArray("X-Atmosphere-Transport",r.attachHeadersAsQueryString)&&(o+="&X-Atmosphere-Transport="+r.transport),-1!==n.util.inArray("X-Atmosphere-TrackMessageSize",r.attachHeadersAsQueryString)&&r.trackMessageLength&&(o+="&X-Atmosphere-TrackMessageSize=true"),-1!==n.util.inArray("X-Heartbeat-Server",r.attachHeadersAsQueryString)&&null!==r.heartbeat&&null!==r.heartbeat.server&&(o+="&X-Heartbeat-Server="+r.heartbeat.server),-1!==n.util.inArray("Content-Type",r.attachHeadersAsQueryString)&&""!==r.contentType&&(o+="&Content-Type="+("websocket"===r.transport?r.contentType:encodeURIComponent(r.contentType))),-1!==n.util.inArray("X-atmo-protocol",r.attachHeadersAsQueryString)&&r.enableProtocol&&(o+="&X-atmo-protocol=true"),n.util.each(r.headers,function(t,a){if(-1!==n.util.inArray(t,r.attachHeadersAsQueryString)){var i=n.util.isFunction(a)?a.call(this,r,e,ge):a;null!=i&&(o+="&"+encodeURIComponent(t)+"="+encodeURIComponent(i))}}),o):(o+="X-Atmosphere-tracking-id="+r.uuid,o+="&X-Atmosphere-Framework="+t,o+="&X-Atmosphere-Transport="+r.transport,r.trackMessageLength&&(o+="&X-Atmosphere-TrackMessageSize=true"),null!==r.heartbeat&&null!==r.heartbeat.server&&(o+="&X-Heartbeat-Server="+r.heartbeat.server),""!==r.contentType&&(o+="&Content-Type="+("websocket"===r.transport?r.contentType:encodeURIComponent(r.contentType))),r.enableProtocol&&(o+="&X-atmo-protocol=true"),n.util.each(r.headers,function(t,a){var i=n.util.isFunction(a)?a.call(this,r,e,ge):a;null!=i&&(o+="&"+encodeURIComponent(t)+"="+encodeURIComponent(i))}),o)):o}function X(e){if(e.isOpen)if(e.isReopen)e.isReopen=!1,T("re-opening",e.transport,e);else{if("messageReceived"!==ge.state||"jsonp"!==e.transport&&"long-polling"!==e.transport)return;F(ge)}else e.isOpen=!0,T("opening",e.transport,e);q(e)}function q(e){if(null!=e.heartbeatTimer&&clearTimeout(e.heartbeatTimer),!isNaN(Se)&&Se>0){var t=function(){c("debug")&&n.util.debug("Sending heartbeat"),_(ke),e.heartbeatTimer=setTimeout(t,Se)};e.heartbeatTimer=setTimeout(t,Se)}}function D(e){var t=pe;if((null!=e||"undefined"!=typeof e)&&(t=e),t.lastIndex=0,t.readyState=0,"jsonp"===t.transport||t.enableXDR&&n.util.checkCORSSupport())return void S(t);if(n.util.browser.msie&&+n.util.browser.version.split(".")[0]<10){if("streaming"===t.transport)return void(t.enableXDR&&window.XDomainRequest?J(t):Q(t));if(t.enableXDR&&window.XDomainRequest)return void J(t)}var o=function(n){if(t.lastIndex=0,Te++,n||t.reconnect&&Te<=t.maxReconnectOnClose){var o=n?0:e.reconnectInterval;ge.ffTryingReconnect=!0,T("re-connecting",e.transport,e),N(i,t,o)}else M(0,"maxReconnectOnClose reached")},r=function(e){n._beforeUnloadState?(n.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){o(e)},5e3)):o(e)},a=function(){ge.errorHandled=!0,p(),r(!1)};if(t.force||t.reconnect&&(-1===t.maxRequest||t.requestCount++<t.maxRequest)){t.force=!1;var i=n.util.xhr();i.hasData=!1,P(i,t,!0),t.suspend&&(be=i),"polling"!==t.transport&&(ge.transport=t.transport,i.onabort=function(){l("ajaxrequest.onabort"),ce(!0)},i.onerror=function(){l("ajaxrequest.onerror"),ge.error=!0,ge.ffTryingReconnect=!0;try{ge.status=XMLHttpRequest.status}catch(e){ge.status=500}ge.status||(ge.status=500),ge.errorHandled||(p(),r(!1))}),i.onreadystatechange=function(){if(l("ajaxRequest.onreadystatechange, new state: "+i.readyState),Re)return void l("onreadystatechange has been ignored due to _abortingConnection flag");ge.error=null;var o=!1,s=!1;if("streaming"===t.transport&&t.readyState>2&&4===i.readyState)return p(),void r(!1);if(t.readyState=i.readyState,"streaming"===t.transport&&i.readyState>=3?s=!0:"long-polling"===t.transport&&4===i.readyState&&(s=!0),O(pe),"polling"!==t.transport){var c=200;if(4===i.readyState&&(c=i.status>1e3?0:i.status),!t.reconnectOnServerError&&c>=300&&600>c)return void M(c,i.statusText);if(c>=300||0===c)return void a();t.enableProtocol&&e.firstMessage||2!==i.readyState||(n.util.browser.mozilla&&ge.ffTryingReconnect?(ge.ffTryingReconnect=!1,setTimeout(function(){ge.ffTryingReconnect||X(t)},500)):X(t))}else 4===i.readyState&&(s=!0);if(s){var d=i.responseText;if(ge.errorHandled=!1,"long-polling"===t.transport&&0===n.util.trim(d).length)return void(i.hasData?i.hasData=!1:r(!0));if(i.hasData=!0,ae(i,pe),"streaming"===t.transport)if(n.util.browser.opera)n.util.iterate(function(){if(500!==ge.status&&i.responseText.length>t.lastIndex){try{ge.status=i.status,ge.headers=n.util.parseHeaders(i.getAllResponseHeaders()),ae(i,pe)}catch(e){ge.status=404}O(pe),ge.state="messageReceived";var r=i.responseText.substring(t.lastIndex);if(t.lastIndex=i.responseText.length,o=H(r,t,ge),o||le(),u(i,t))return void E(i,t)}else if(ge.status>400)return t.lastIndex=i.responseText.length,!1},0);else{var f=d.substring(t.lastIndex,d.length);if(o=H(f,t,ge),t.lastIndex=d.length,o)return}else o=H(d,t,ge);var g=u(i,t);try{ge.status=i.status,ge.headers=n.util.parseHeaders(i.getAllResponseHeaders()),ae(i,t)}catch(m){ge.status=404}t.suspend?ge.state=0===ge.status?"closed":"messageReceived":ge.state="messagePublished";var h=!g&&"streaming"!==e.transport&&"polling"!==e.transport;h&&!t.executeCallbackBeforeReconnect&&N(i,t,t.pollingInterval),0===ge.responseBody.length||o||le(),h&&t.executeCallbackBeforeReconnect&&N(i,t,t.pollingInterval),g&&E(i,t)}};try{i.send(t.data),we=!0}catch(s){n.util.log(t.logLevel,["Unable to connect to "+t.url]),M(0,s)}}else"debug"===t.logLevel&&n.util.log(t.logLevel,["Max re-connection reached."]),M(0,"maxRequest reached")}function E(e,t){ge.messages=[],t.isReopen=!0,f(),Re=!1,N(e,t,500)}function P(e,o,r){var a=o.url;null!=o.dispatchUrl&&"POST"===o.method&&(a+=o.dispatchUrl),a=B(o,a),a=n.util.prepareURL(a),r&&(e.open(o.method,a,o.async),o.connectTimeout>0&&(o.id=setTimeout(function(){0===o.requestCount&&(p(),re("Connect timeout","closed",200,o.transport))},o.connectTimeout))),pe.withCredentials&&"websocket"!==pe.transport&&"withCredentials"in e&&(e.withCredentials=!0),n.util.isArray(pe.dropHeaders)?(-1===n.util.inArray("X-Atmosphere-Framework",pe.dropHeaders)&&e.setRequestHeader("X-Atmosphere-Framework",t),-1===n.util.inArray("X-Atmosphere-Transport",pe.dropHeaders)&&e.setRequestHeader("X-Atmosphere-Transport",o.transport),-1===n.util.inArray("X-Heartbeat-Server",pe.dropHeaders)&&null!==o.heartbeat&&null!==o.heartbeat.server&&e.setRequestHeader("X-Heartbeat-Server",e.heartbeat.server),-1===n.util.inArray("X-Atmosphere-TrackMessageSize",pe.dropHeaders)&&o.trackMessageLength&&e.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),-1===n.util.inArray("X-Atmosphere-tracking-id",pe.dropHeaders)&&e.setRequestHeader("X-Atmosphere-tracking-id",o.uuid),n.util.each(o.headers,function(t,a){if(-1===n.util.inArray(t,pe.dropHeaders)){var i=n.util.isFunction(a)?a.call(this,e,o,r,ge):a;null!=i&&e.setRequestHeader(t,i)}})):pe.dropHeaders||(e.setRequestHeader("X-Atmosphere-Framework",t),e.setRequestHeader("X-Atmosphere-Transport",o.transport),null!==o.heartbeat&&null!==o.heartbeat.server&&e.setRequestHeader("X-Heartbeat-Server",e.heartbeat.server),o.trackMessageLength&&e.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),e.setRequestHeader("X-Atmosphere-tracking-id",o.uuid),n.util.each(o.headers,function(t,a){var i=n.util.isFunction(a)?a.call(this,e,o,r,ge):a;null!=i&&e.setRequestHeader(t,i)})),""!==o.contentType&&e.setRequestHeader("Content-Type",o.contentType)}function N(e,t,n){if(!ge.closedByClientTimeout&&(t.reconnect||t.suspend&&we)){var o=0;e&&e.readyState>1&&(o=e.status>1e3?0:e.status),ge.status=0===o?204:o,ge.reason=0===o?"Server resumed the connection or down.":"OK",clearTimeout(t.id),t.reconnectId&&(clearTimeout(t.reconnectId),delete t.reconnectId),n>0?pe.reconnectId=setTimeout(function(){D(t)},n):D(t)}}function j(e){e.state="re-connecting",ie(e)}function F(e){e.state="openAfterResume",ie(e),e.state="messageReceived"}function J(e){"polling"!==e.transport?(ve=W(e),ve.open()):W(e).open()}function W(e){var t=pe;null!=e&&"undefined"!=typeof e&&(t=e);var o=t.transport,r=0,a=new window.XDomainRequest,i=function(){"long-polling"===t.transport&&t.reconnect&&(-1===t.maxRequest||t.requestCount++<t.maxRequest)&&(a.status=200,J(t))},s=t.rewriteURL||function(e){var t=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(t&&t[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+t[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+t[2]+"&").replace(/&$/,"")}return e};a.onprogress=function(){c(a)},a.onerror=function(){"polling"!==t.transport&&(p(),Te++<t.maxReconnectOnClose?t.reconnectInterval>0?t.reconnectId=setTimeout(function(){T("re-connecting",e.transport,e),J(t)},t.reconnectInterval):(T("re-connecting",e.transport,e),J(t)):M(0,"maxReconnectOnClose reached"))},a.onload=function(){};var c=function(e){clearTimeout(t.id);var a=e.responseText;if(a=a.substring(r),r+=a.length,"polling"!==o){O(t);var s=H(a,t,ge);if("long-polling"===o&&0===n.util.trim(a).length)return;t.executeCallbackBeforeReconnect&&i(),s||re(ge.responseBody,"messageReceived",200,o),t.executeCallbackBeforeReconnect||i()}};return{open:function(){var e=t.url;null!=t.dispatchUrl&&(e+=t.dispatchUrl),e=B(t,e),a.open(t.method,s(e)),"GET"===t.method?a.send():a.send(t.data),t.connectTimeout>0&&(t.id=setTimeout(function(){0===t.requestCount&&(p(),re("Connect timeout","closed",200,t.transport))},t.connectTimeout))},close:function(){a.abort()}}}function Q(e){ve=z(e),ve.open()}function z(e){var t=pe;null!=e&&"undefined"!=typeof e&&(t=e);var o,r=new window.ActiveXObject("htmlfile");r.open(),r.close();var a=t.url;return null!=t.dispatchUrl&&(a+=t.dispatchUrl),"polling"!==t.transport&&(ge.transport=t.transport),{open:function(){var e=r.createElement("iframe");a=B(t),""!==t.data&&(a+="&X-Atmosphere-Post-Body="+encodeURIComponent(t.data)),a=n.util.prepareURL(a),e.src=a,r.body.appendChild(e);var i=e.contentDocument||e.contentWindow.document;o=n.util.iterate(function(){try{if(!i.firstChild)return;var e=i.body?i.body.lastChild:i,a=function(){var t=e.cloneNode(!0);t.appendChild(i.createTextNode("."));var n=t.innerText;return n=n.substring(0,n.length-1)};if(!i.body||!i.body.firstChild||"pre"!==i.body.firstChild.nodeName.toLowerCase()){var s=i.head||i.getElementsByTagName("head")[0]||i.documentElement||i,c=i.createElement("script");c.text="document.write('<plaintext>')",s.insertBefore(c,s.firstChild),s.removeChild(c),e=i.body.lastChild}return t.closed&&(t.isReopen=!0),o=n.util.iterate(function(){var n=a();if(n.length>t.lastIndex){O(pe),ge.status=200,ge.error=null,e.innerText="";var o=H(n,t,ge);if(o)return"";re(ge.responseBody,"messageReceived",200,t.transport)}return t.lastIndex=0,"complete"===i.readyState?(ce(!0),T("re-connecting",t.transport,t),t.reconnectInterval>0?t.reconnectId=setTimeout(function(){Q(t)},t.reconnectInterval):Q(t),!1):void 0},null),!1}catch(l){return ge.error=!0,T("re-connecting",t.transport,t),Te++<t.maxReconnectOnClose?t.reconnectInterval>0?t.reconnectId=setTimeout(function(){Q(t)},t.reconnectInterval):Q(t):M(0,"maxReconnectOnClose reached"),r.execCommand("Stop"),r.close(),!1}})},close:function(){o&&o(),r.execCommand("Stop"),ce(!0)}}}function _(e){null!=xe?G(e):null!=be||null!=he?V(e):null!=ve?Y(e):null!=ye?Z(e):null!=me?ne(e):(M(0,"No suspended connection available"),n.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function $(e,t){t||(t=te(e)),t.transport="polling",t.method="GET",t.withCredentials=!1,t.reconnect=!1,t.force=!0,t.suspend=!1,t.timeout=1e3,D(t)}function G(e){xe.send(e)}function K(e){if(0!==e.length)try{xe?xe.localSend(e):ue&&ue.signal("localMessage",n.util.stringifyJSON({id:Ae,event:e}))}catch(t){n.util.error(t)}}function V(e){var t=te(e);D(t)}function Y(e){if(pe.enableXDR&&n.util.checkCORSSupport()){var t=te(e);t.reconnect=!1,S(t)}else V(e)}function Z(e){V(e)}function ee(e){var t=e;return"object"==typeof t&&(t=e.data),t}function te(e){var t=ee(e),o={connected:!1,timeout:6e4,method:"POST",url:pe.url,contentType:pe.contentType,headers:pe.headers,reconnect:!0,callback:null,data:t,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:pe.withCredentials,async:pe.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:pe.enableXDR,uuid:pe.uuid,dispatchUrl:pe.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:pe.trackMessageLength,maxReconnectOnClose:pe.maxReconnectOnClose,heartbeatTimer:pe.heartbeatTimer,heartbeat:pe.heartbeat};return"object"==typeof e&&(o=n.util.extend(o,e)),o}function ne(e){var t,o=n.util.isBinary(e)?e:ee(e);try{if(t=null!=pe.dispatchUrl?pe.webSocketPathDelimiter+pe.dispatchUrl+pe.webSocketPathDelimiter+o:o,!me.canSendMessage)return void n.util.error("WebSocket not connected.");me.send(t)}catch(r){me.onclose=function(e){},p(),U("Websocket failed. Downgrading to "+pe.fallbackTransport+" and resending "+e),V(e)}}function oe(e){var t=n.util.parseJSON(e);t.id!==Ae&&("undefined"!=typeof pe.onLocalMessage?pe.onLocalMessage(t.event):"undefined"!=typeof n.util.onLocalMessage&&n.util.onLocalMessage(t.event))}function re(e,t,n,o){ge.responseBody=e,ge.transport=o,ge.status=n,ge.state=t,le()}function ae(e,t){if(t.readResponsesHeaders)try{var n=e.getResponseHeader("X-Atmosphere-tracking-id");n&&null!=n&&(t.uuid=n.split(" ").pop())}catch(o){}else t.enableProtocol||(t.uuid=Ae)}function ie(e){se(e,pe),se(e,n.util)}function se(e,t){switch(e.state){case"messageReceived":l("Firing onMessage"),Te=0,"undefined"!=typeof t.onMessage&&t.onMessage(e),"undefined"!=typeof t.onmessage&&t.onmessage(e);break;case"error":var n="undefined"!=typeof e.reasonPhrase?e.reasonPhrase:"n/a";l("Firing onError, reasonPhrase: "+n),"undefined"!=typeof t.onError&&t.onError(e),"undefined"!=typeof t.onerror&&t.onerror(e);break;case"opening":delete pe.closed,l("Firing onOpen"),"undefined"!=typeof t.onOpen&&t.onOpen(e),"undefined"!=typeof t.onopen&&t.onopen(e);
break;case"messagePublished":l("Firing messagePublished"),"undefined"!=typeof t.onMessagePublished&&t.onMessagePublished(e);break;case"re-connecting":l("Firing onReconnect"),"undefined"!=typeof t.onReconnect&&t.onReconnect(pe,e);break;case"closedByClient":l("Firing closedByClient"),"undefined"!=typeof t.onClientTimeout&&t.onClientTimeout(pe);break;case"re-opening":delete pe.closed,l("Firing onReopen"),"undefined"!=typeof t.onReopen&&t.onReopen(pe,e);break;case"fail-to-reconnect":l("Firing onFailureToReconnect"),"undefined"!=typeof t.onFailureToReconnect&&t.onFailureToReconnect(pe,e);break;case"unsubscribe":case"closed":var o="undefined"!=typeof pe.closed?pe.closed:!1;o?l("Request already closed, not firing onClose ("+e.state+" case)"):(l("Firing onClose ("+e.state+" case)"),"undefined"!=typeof t.onClose&&t.onClose(e),"undefined"!=typeof t.onclose&&t.onclose(e)),pe.closed=!0;break;case"openAfterResume":"undefined"!=typeof t.onOpenAfterResume&&t.onOpenAfterResume(pe)}}function ce(e){"closed"!==ge.state&&(ge.state="closed",ge.responseBody="",ge.messages=[],ge.status=e?200:501,le())}function le(){var e=function(e,t){t(ge)};null==xe&&null!=Ce&&Ce(ge.responseBody),pe.reconnect=pe.mrequest;for(var t="string"==typeof ge.responseBody,o=t&&pe.trackMessageLength?ge.messages.length>0?ge.messages:[""]:new Array(ge.responseBody),r=0;r<o.length;r++)if(!(o.length>1&&0===o[r].length||(ge.responseBody=t?n.util.trim(o[r]):o[r],null==xe&&null!=Ce&&Ce(ge.responseBody),(0===ge.responseBody.length||t&&ke===ge.responseBody)&&"messageReceived"===ge.state))){if(ie(ge),a.length>0){c("debug")&&n.util.debug("Invoking "+a.length+" global callbacks: "+ge.state);try{n.util.each(a,e)}catch(i){n.util.log(pe.logLevel,["Callback exception"+i])}}if("function"==typeof pe.callback){c("debug")&&n.util.debug("Invoking request callbacks");try{pe.callback(ge)}catch(i){n.util.log(pe.logLevel,["Callback exception"+i])}}}}var ue,de,fe,pe={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,t){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},ge={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},me=null,he=null,be=null,ve=null,ye=null,we=!0,Te=0,Se=0,ke="X",Re=!1,Ce=null,xe=null,Ae=n.util.now();m(e),this.subscribe=function(e){m(e),v()},this.execute=function(){v()},this.close=function(){f()},this.disconnect=function(){d()},this.getUrl=function(){return pe.url},this.push=function(e,t){if(null!=t){var n=pe.dispatchUrl;pe.dispatchUrl=t,_(e),pe.dispatchUrl=n}else _(e)},this.getUUID=function(){return pe.uuid},this.pushLocal=function(e){K(e)},this.enableProtocol=function(e){return pe.enableProtocol},this.init=function(){r()},this.request=pe,this.response=ge}},n.subscribe=function(e,t,o){"function"==typeof t&&n.addCallback(t),"string"!=typeof e?o=e:o.url=e,i="undefined"!=typeof o&&"undefined"!=typeof o.uuid?o.uuid:0;var a=new n.AtmosphereRequest(o);return a.execute(),r[r.length]=a,a},n.unsubscribe=function(){if(r.length>0)for(var e=[].concat(r),t=0;t<e.length;t++){var n=e[t];n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer)}r=[],a=[]},n.unsubscribeUrl=function(e){var t=-1;if(r.length>0)for(var n=0;n<r.length;n++){var o=r[n];if(o.getUrl()===e){o.close(),clearTimeout(o.response.request.id),o.heartbeatTimer&&clearTimeout(o.heartbeatTimer),t=n;break}}t>=0&&r.splice(t,1)},n.addCallback=function(e){-1===n.util.inArray(e,a)&&a.push(e)},n.removeCallback=function(e){var t=n.util.inArray(e,a);-1!==t&&a.splice(t,1)},n.util={browser:{},parseHeaders:function(e){for(var t,n=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,o={};t=n.exec(e);)o[t[1]]=t[2];return o},now:function(){return(new Date).getTime()},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},inArray:function(e,t){if(!Array.prototype.indexOf){for(var n=t.length,o=0;n>o;++o)if(t[o]===e)return o;return-1}return t.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},getAbsoluteURL:function(e){var t=document.createElement("div");return t.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(t.firstChild.href))},prepareURL:function(e){var t=n.util.now(),o=e.replace(/([?&])_=[^&]*/,"$1_="+t);return o+(o===e?(/\?/.test(e)?"&":"?")+"_="+t:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(e){function t(e,t){t=n.util.isFunction(t)?t():null==t?"":t,a.push(encodeURIComponent(e)+"="+encodeURIComponent(t))}function o(e,r){var a;if(n.util.isArray(r))n.util.each(r,function(n,r){/\[\]$/.test(e)?t(e,r):o(e+"["+("object"==typeof r?n:"")+"]",r)});else if("[object Object]"===Object.prototype.toString.call(r))for(a in r)o(e+"["+a+"]",r[a]);else t(e,r)}var r,a=[];for(r in e)o(r,e[r]);return a.join("&").replace(/%20/g,"+")},storage:function(){try{return!(!window.localStorage||!window.StorageEvent)}catch(e){return!1}},iterate:function(e,t){var n;return t=t||0,function o(){n=setTimeout(function(){e()!==!1&&o()},t)}(),function(){clearTimeout(n)}},each:function(e,t,o){if(e){var r,a=0,i=e.length,s=n.util.isArray(e);if(o){if(s)for(;i>a&&(r=t.apply(e[a],o),r!==!1);a++);else for(a in e)if(r=t.apply(e[a],o),r===!1)break}else if(s)for(;i>a&&(r=t.call(e[a],a,e[a]),r!==!1);a++);else for(a in e)if(r=t.call(e[a],a,e[a]),r===!1)break;return e}},extend:function(e){var t,n,o;for(t=1;t<arguments.length;t++)if(null!=(n=arguments[t]))for(o in n)e[o]=n[o];return e},on:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},off:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},log:function(e,t){if(window.console){var n=window.console[e];"function"==typeof n&&n.apply(window.console,t)}},warn:function(){n.util.log("warn",arguments)},info:function(){n.util.log("info",arguments)},debug:function(){n.util.log("debug",arguments)},error:function(){n.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}},parseJSON:function(e){return e?window.JSON&&window.JSON.parse?window.JSON.parse(e):new Function("return "+e)():null},stringifyJSON:function(e){function t(e){return'"'+e.replace(o,function(e){var t=r[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function n(e){return 10>e?"0"+e:e}var o=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,r={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function a(e,o){var r,i,c,l,u=o[e],d=typeof u;switch(u&&"object"==typeof u&&"function"==typeof u.toJSON&&(u=u.toJSON(e),d=typeof u),d){case"string":return t(u);case"number":return isFinite(u)?String(u):"null";case"boolean":return String(u);case"object":if(!u)return"null";switch(Object.prototype.toString.call(u)){case"[object Date]":return isFinite(u.valueOf())?'"'+u.getUTCFullYear()+"-"+n(u.getUTCMonth()+1)+"-"+n(u.getUTCDate())+"T"+n(u.getUTCHours())+":"+n(u.getUTCMinutes())+":"+n(u.getUTCSeconds())+'Z"':"null";case"[object Array]":for(c=u.length,l=[],r=0;c>r;r++)l.push(a(r,u)||"null");return"["+l.join(",")+"]";default:l=[];for(r in u)s.call(u,r)&&(i=a(r,u),i&&l.push(t(r)+":"+i));return"{"+l.join(",")+"}"}}}("",{"":e})},checkCORSSupport:function(){if(n.util.browser.msie&&!window.XDomainRequest&&+n.util.browser.version.split(".")[0]<11)return!0;if(n.util.browser.opera&&+n.util.browser.version.split(".")<12)return!0;if("KreaTVWebKit/531"===n.util.trim(navigator.userAgent).slice(0,16))return!0;if("kreatel"===n.util.trim(navigator.userAgent).slice(-7).toLowerCase())return!0;var e=navigator.userAgent.toLowerCase(),t=e.indexOf("android")>-1;return t?!0:!1}},e=n.util.now(),function(){var e=navigator.userAgent.toLowerCase(),t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(e)||e.indexOf("android")<0&&/version\/(.+) (safari)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];"safari"===t[2]&&(t[2]=t[1],t[1]="safari"),n.util.browser[t[1]||""]=!0,n.util.browser.version=t[2]||"0",n.util.browser.vmajor=n.util.browser.version.split(".")[0],n.util.browser.trident&&(n.util.browser.msie=!0),(n.util.browser.msie||n.util.browser.mozilla&&1===+n.util.browser.version.split(".")[0])&&(n.util.storage=!1)}(),n.util.on(window,"unload",function(e){n.util.debug(new Date+" Atmosphere: unload event"),n.unsubscribe()}),n.util.on(window,"beforeunload",function(e){n.util.debug(new Date+" Atmosphere: beforeunload event"),n._beforeUnloadState=!0,setTimeout(function(){n.util.debug(new Date+" Atmosphere: beforeunload event timeout reached. Reset _beforeUnloadState flag"),n._beforeUnloadState=!1},5e3)}),n.util.on(window,"keypress",function(e){(27===e.charCode||27===e.keyCode)&&e.preventDefault&&e.preventDefault()}),n.util.on(window,"offline",function(){if(n.util.debug(new Date+" Atmosphere: offline event"),o=!0,r.length>0)for(var e=[].concat(r),t=0;t<e.length;t++){var a=e[t];a.handleOnlineOffline&&(a.close(),clearTimeout(a.response.request.id),a.heartbeatTimer&&clearTimeout(a.heartbeatTimer))}}),n.util.on(window,"online",function(){if(n.util.debug(new Date+" Atmosphere: online event"),r.length>0)for(var e=0;e<r.length;e++)r[e].handleOnlineOffline&&(r[e].init(),r[e].execute());o=!1}),n});